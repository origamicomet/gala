#!/usr/bin/ruby

require 'rbconfig'

PLATFORM = lambda {
  if RbConfig::CONFIG['target_os'] =~ /windows/i
    'windows'
  elsif RbConfig::CONFIG['target_os'] =~ /mingw32/i
    'windows'
  elsif RbConfig::CONFIG['target_os'] =~ /cygwin/i
    'cygwin'
  elsif RbConfig::CONFIG['target_os'] =~ /darwin/i
    'macosx'
  elsif RbConfig::CONFIG['target_os'] =~ /linux/i
    'linux'
  elsif RbConfig::CONFIG['target_os'] =~ /bsd/i
    'bsd'
  else
    raise "#{RbConfig::CONFIG['target_os']} is an unknown platform!"
  end
}.call

case ARGV[0]
  when 'debug'
  when 'release'
  else
    raise "`#{ARGV[0]}` is an invalid configuration!\n"
end

BUILD = ARGV[0]
LIB_BUILD = ARGV[0]

File.open('tup.config', 'w') do |cfg|
  cfg.write "# This file was generated by ./configure #{ARGV.join(' ')}\n\n"
  cfg.write "CONFIG_AGL_BUILD=#{BUILD}\n"

  if PLATFORM == 'windows'
    DXSDK_DIR = `set DXSDK_DIR`.split('DXSDK_DIR=')[1].strip
    cfg.write "CONFIG_DXSDK_DIR=#{DXSDK_DIR}\n"
  end

  if PLATFORM == 'windows'
    WINDOWS_SDK_DIR = lambda {
      ARGV.each { |arg|
        if arg =~ /--winsdk=/
          return arg.split('=')[1]
        end
      }

      return "C:\\Program Files\\Microsoft SDKs\\Windows\\v7.1"
    }.call

    cfg.write "CONFIG_WINDOWS_SDK_DIR=#{WINDOWS_SDK_DIR}\n"
  end
end
